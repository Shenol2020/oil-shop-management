{% extends "base.html" %}

{% block title %}Sales - Oil Shop Management{% endblock %}
{% block page_title %}Point of Sale{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Left Side - Product Selection -->
        <div class="col-md-7">
            <!-- Barcode Scanner -->
            <div class="barcode-scanner">
                <h5><i class="bi bi-upc-scan"></i> Barcode Scanner</h5>
                <div class="input-group mt-3">
                    <input type="text" class="form-control barcode-input" id="barcodeInput" 
                           placeholder="Scan barcode or enter manually..." autofocus>
                    <button class="btn btn-light" onclick="searchProduct()">
                        <i class="bi bi-search"></i> Search
                    </button>
                </div>
                <small class="text-white-50 mt-2 d-block">
                    <i class="bi bi-info-circle"></i> Focus on the input field and scan a barcode
                </small>
            </div>

            <!-- Product Search -->
            <div class="card card-custom mt-3">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-search"></i> Search Products
                    </h5>
                    <input type="text" class="form-control" id="productSearch" 
                           placeholder="Search by product name...">
                    <div id="searchResults" class="mt-3"></div>
                </div>
            </div>

            <!-- Quick Add Products -->
            <div class="card card-custom mt-3">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-grid-3x3"></i> Quick Add Products
                    </h5>
                    <div id="quickProducts" class="row">
                        <div class="col-12 text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side - Cart & Checkout -->
        <div class="col-md-5">
            <div class="card card-custom">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-cart"></i> Shopping Cart
                        <span class="badge bg-primary" id="cartCount">0</span>
                    </h5>

                    <!-- Cart Items -->
                    <div id="cartItems" style="max-height: 300px; overflow-y: auto;">
                        <p class="text-center text-muted mt-4">Cart is empty</p>
                    </div>

                    <hr>

                    <!-- Customer Info -->
                    <div class="mb-3">
                        <label class="form-label">Customer Name (Optional)</label>
                        <input type="text" class="form-control" id="customerName" value="Walk-in">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone (Optional)</label>
                        <input type="text" class="form-control" id="customerPhone">
                    </div>

                    <!-- Discount -->
                    <div class="mb-3">
                        <label class="form-label">Discount ($)</label>
                        <input type="number" class="form-control" id="discount" value="0" min="0" step="0.01">
                    </div>

                    <!-- Payment Method -->
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <select class="form-select" id="paymentMethod">
                            <option value="cash">Cash</option>
                            <option value="card">Card</option>
                            <option value="online">Online</option>
                        </select>
                    </div>

                    <hr>

                    <!-- Totals -->
                    <div class="d-flex justify-content-between mb-2">
                        <strong>Subtotal:</strong>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <strong>Discount:</strong>
                        <span id="discountAmount">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <h5><strong>Total:</strong></h5>
                        <h5 class="text-primary"><strong id="total">$0.00</strong></h5>
                    </div>

                    <!-- Action Buttons -->
                    <button class="btn btn-success btn-custom w-100 mb-2" onclick="processCheckout()">
                        <i class="bi bi-check-circle"></i> Complete Sale
                    </button>
                    <button class="btn btn-danger btn-custom w-100" onclick="clearCart()">
                        <i class="bi bi-x-circle"></i> Clear Cart
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sale Completed!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 4em;"></i>
                <h4 class="mt-3">Payment Successful</h4>
                <p class="text-muted">Invoice #<span id="invoiceNumber"></span></p>
                <p>Total Amount: <strong id="invoiceTotal"></strong></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="printInvoice()">
                    <i class="bi bi-printer"></i> Print Invoice
                </button>
                <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let cart = [];
    let products = [];
    let lastSaleId = null;

    // Load all products
    async function loadProducts() {
        try {
            const response = await fetch('/api/products');
            products = await response.json();
            displayQuickProducts();
        } catch (error) {
            console.error('Error loading products:', error);
            showAlert('Error loading products', 'danger');
        }
    }

    // Display quick add products
    function displayQuickProducts() {
        const container = document.getElementById('quickProducts');
        const topProducts = products.slice(0, 6);
        
        container.innerHTML = topProducts.map(product => `
            <div class="col-md-6 mb-2">
                <button class="btn btn-outline-primary w-100" onclick="addToCart(${product.id}, '${product.name}', ${product.price})">
                    <small><strong>${product.name}</strong><br>$${product.price}</small>
                </button>
            </div>
        `).join('');
    }

    // Barcode scanner
    let barcodeBuffer = '';
    let barcodeTimeout;

    document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchProduct();
        } else {
            clearTimeout(barcodeTimeout);
            barcodeBuffer += e.key;
            barcodeTimeout = setTimeout(() => {
                barcodeBuffer = '';
            }, 100);
        }
    });

    async function searchProduct() {
        const barcode = document.getElementById('barcodeInput').value.trim();
        if (!barcode) return;

        try {
            const response = await fetch(`/api/products/${barcode}`);
            if (response.ok) {
                const product = await response.json();
                addToCart(product.id, product.name, product.price, product.quantity);
                document.getElementById('barcodeInput').value = '';
                showAlert(`Added ${product.name} to cart`, 'success');
            } else {
                showAlert('Product not found', 'warning');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Error searching product', 'danger');
        }
    }

    // Product search
    document.getElementById('productSearch').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        if (searchTerm.length < 2) {
            document.getElementById('searchResults').innerHTML = '';
            return;
        }

        const results = products.filter(p => 
            p.name.toLowerCase().includes(searchTerm) || 
            p.category.toLowerCase().includes(searchTerm)
        ).slice(0, 5);

        document.getElementById('searchResults').innerHTML = results.map(product => `
            <div class="product-item">
                <div>
                    <strong>${product.name}</strong><br>
                    <small class="text-muted">${product.category} - Stock: ${product.quantity}</small>
                </div>
                <div class="text-end">
                    <strong>$${product.price}</strong><br>
                    <button class="btn btn-sm btn-primary" onclick="addToCart(${product.id}, '${product.name}', ${product.price}, ${product.quantity})">
                        Add
                    </button>
                </div>
            </div>
        `).join('');
    });

    // Cart management
    function addToCart(productId, productName, price, stock = 999) {
        const existingItem = cart.find(item => item.product_id === productId);
        
        if (existingItem) {
            if (existingItem.quantity >= stock) {
                showAlert('Not enough stock', 'warning');
                return;
            }
            existingItem.quantity++;
        } else {
            cart.push({
                product_id: productId,
                name: productName,
                price: parseFloat(price),
                quantity: 1
            });
        }
        
        updateCart();
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
        updateCart();
    }

    function updateQuantity(index, change) {
        cart[index].quantity += change;
        if (cart[index].quantity <= 0) {
            removeFromCart(index);
        } else {
            updateCart();
        }
    }

    function updateCart() {
        const cartContainer = document.getElementById('cartItems');
        const cartCount = document.getElementById('cartCount');
        
        cartCount.textContent = cart.length;
        
        if (cart.length === 0) {
            cartContainer.innerHTML = '<p class="text-center text-muted mt-4">Cart is empty</p>';
        } else {
            cartContainer.innerHTML = cart.map((item, index) => `
                <div class="product-item mb-2">
                    <div>
                        <strong>${item.name}</strong><br>
                        <small>$${item.price.toFixed(2)} each</small>
                    </div>
                    <div class="text-end">
                        <div class="btn-group btn-group-sm mb-1">
                            <button class="btn btn-outline-secondary" onclick="updateQuantity(${index}, -1)">-</button>
                            <button class="btn btn-outline-secondary disabled">${item.quantity}</button>
                            <button class="btn btn-outline-secondary" onclick="updateQuantity(${index}, 1)">+</button>
                        </div><br>
                        <strong>$${(item.price * item.quantity).toFixed(2)}</strong>
                        <button class="btn btn-sm btn-danger ms-2" onclick="removeFromCart(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        calculateTotal();
    }

    function calculateTotal() {
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const discount = parseFloat(document.getElementById('discount').value) || 0;
        const total = Math.max(0, subtotal - discount);
        
        document.getElementById('subtotal').textContent = formatCurrency(subtotal);
        document.getElementById('discountAmount').textContent = formatCurrency(discount);
        document.getElementById('total').textContent = formatCurrency(total);
    }

    document.getElementById('discount').addEventListener('input', calculateTotal);

    function clearCart() {
        if (cart.length === 0) return;
        if (confirm('Clear all items from cart?')) {
            cart = [];
            updateCart();
        }
    }

    async function processCheckout() {
        if (cart.length === 0) {
            showAlert('Cart is empty', 'warning');
            return;
        }

        const customerName = document.getElementById('customerName').value || 'Walk-in';
        const customerPhone = document.getElementById('customerPhone').value;
        const discount = parseFloat(document.getElementById('discount').value) || 0;
        const paymentMethod = document.getElementById('paymentMethod').value;
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const total = Math.max(0, subtotal - discount);

        const saleData = {
            customer_name: customerName,
            customer_phone: customerPhone,
            total_amount: total,
            discount: discount,
            payment_method: paymentMethod,
            items: cart.map(item => ({
                product_id: item.product_id,
                quantity: item.quantity,
                price: item.price,
                subtotal: item.price * item.quantity
            }))
        };

        try {
            const response = await fetch('/api/sales', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(saleData)
            });

            const result = await response.json();
            
            if (response.ok && result.success) {
                lastSaleId = result.sale_id;
                document.getElementById('invoiceNumber').textContent = result.sale_id;
                document.getElementById('invoiceTotal').textContent = formatCurrency(total);
                
                const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
                modal.show();
                
                // Clear cart
                cart = [];
                updateCart();
                document.getElementById('customerName').value = 'Walk-in';
                document.getElementById('customerPhone').value = '';
                document.getElementById('discount').value = '0';
                
                // Reload products to update stock
                loadProducts();
            } else {
                showAlert(result.error || 'Error processing sale', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Error processing sale', 'danger');
        }
    }

    function printInvoice() {
        if (lastSaleId) {
            window.open(`/api/sales/${lastSaleId}/invoice`, '_blank');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadProducts();
    });
</script>
{% endblock %}