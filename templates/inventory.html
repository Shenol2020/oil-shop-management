{% extends "base.html" %}

{% block title %}Inventory - Oil Shop Management{% endblock %}
{% block page_title %}Inventory Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-6">
            <input type="text" class="form-control" id="searchInput" placeholder="Search products...">
        </div>
        <div class="col-md-3">
            <select class="form-select" id="categoryFilter">
                <option value="">All Categories</option>
            </select>
        </div>
        <div class="col-md-3">
            {% if user.role in ['admin', 'manager'] %}
            <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#productModal" onclick="resetProductForm()">
                <i class="bi bi-plus-circle"></i> Add Product
            </button>
            {% endif %}
        </div>
    </div>

    <div class="card card-custom">
        <div class="card-body">
            <h5 class="card-title">
                <i class="bi bi-box-seam"></i> Product List
            </h5>
            <div class="table-responsive">
                <table class="table table-custom">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Barcode</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Supplier</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Product Name *</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Barcode *</label>
                            <input type="text" class="form-control" id="barcode" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category *</label>
                            <select class="form-select" id="category" required>
                                <option value="">Select Category</option>
                                <option value="Engine Oil">Engine Oil</option>
                                <option value="Diesel Oil">Diesel Oil</option>
                                <option value="Motorcycle Oil">Motorcycle Oil</option>
                                <option value="Hydraulic Oil">Hydraulic Oil</option>
                                <option value="Gear Oil">Gear Oil</option>
                                <option value="Transmission Oil">Transmission Oil</option>
                                <option value="Brake Fluid">Brake Fluid</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Supplier</label>
                            <select class="form-select" id="supplierId">
                                <option value="">Select Supplier</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Selling Price *</label>
                            <input type="number" class="form-control" id="price" step="0.01" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Cost Price</label>
                            <input type="number" class="form-control" id="costPrice" step="0.01">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="quantity" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Min Stock Level</label>
                            <input type="number" class="form-control" id="minStockLevel" value="10">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="description" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">Save Product</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let products = [];
    let suppliers = [];

    async function loadProducts() {
        try {
            const response = await fetch('/api/products');
            products = await response.json();
            displayProducts(products);
            populateCategoryFilter();
        } catch (error) {
            console.error('Error loading products:', error);
            showAlert('Error loading products', 'danger');
        }
    }

    async function loadSuppliers() {
        try {
            const response = await fetch('/api/suppliers');
            suppliers = await response.json();
            const select = document.getElementById('supplierId');
            select.innerHTML = '<option value="">Select Supplier</option>' + 
                suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        } catch (error) {
            console.error('Error loading suppliers:', error);
        }
    }

    function displayProducts(productList) {
        const tbody = document.getElementById('productsTable');
        
        if (productList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center">No products found</td></tr>';
            return;
        }

        tbody.innerHTML = productList.map(product => {
            const stockClass = product.quantity <= product.min_stock_level ? 'danger' : 
                              product.quantity <= product.min_stock_level * 2 ? 'warning' : 'success';
            
            return `
                <tr>
                    <td>${product.id}</td>
                    <td><code>${product.barcode}</code></td>
                    <td><strong>${product.name}</strong></td>
                    <td><span class="badge bg-info">${product.category}</span></td>
                    <td><strong>$${product.price}</strong></td>
                    <td><span class="badge bg-${stockClass}">${product.quantity}</span></td>
                    <td>${product.supplier_name || 'N/A'}</td>
                    <td>
                        {% if user.role in ['admin', 'manager'] %}
                        <button class="btn btn-sm btn-primary" onclick="editProduct(${product.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        {% if user.role == 'admin' %}
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                        {% endif %}
                        {% endif %}
                    </td>
                </tr>
            `;
        }).join('');
    }

    function populateCategoryFilter() {
        const categories = [...new Set(products.map(p => p.category))];
        const select = document.getElementById('categoryFilter');
        select.innerHTML = '<option value="">All Categories</option>' + 
            categories.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    // Search and filter
    document.getElementById('searchInput').addEventListener('input', function(e) {
        filterProducts();
    });

    document.getElementById('categoryFilter').addEventListener('change', function(e) {
        filterProducts();
    });

    function filterProducts() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const category = document.getElementById('categoryFilter').value;
        
        const filtered = products.filter(p => {
            const matchesSearch = p.name.toLowerCase().includes(searchTerm) || 
                                p.barcode.includes(searchTerm) ||
                                p.category.toLowerCase().includes(searchTerm);
            const matchesCategory = !category || p.category === category;
            return matchesSearch && matchesCategory;
        });
        
        displayProducts(filtered);
    }

    function resetProductForm() {
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        document.getElementById('modalTitle').textContent = 'Add Product';
    }

    function editProduct(id) {
        const product = products.find(p => p.id === id);
        if (!product) return;

        document.getElementById('productId').value = product.id;
        document.getElementById('productName').value = product.name;
        document.getElementById('barcode').value = product.barcode;
        document.getElementById('category').value = product.category;
        document.getElementById('supplierId').value = product.supplier_id || '';
        document.getElementById('price').value = product.price;
        document.getElementById('costPrice').value = product.cost_price;
        document.getElementById('quantity').value = product.quantity;
        document.getElementById('minStockLevel').value = product.min_stock_level;
        document.getElementById('description').value = product.description || '';
        
        document.getElementById('modalTitle').textContent = 'Edit Product';
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
    }

    async function saveProduct() {
        const form = document.getElementById('productForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const productId = document.getElementById('productId').value;
        const productData = {
            name: document.getElementById('productName').value,
            barcode: document.getElementById('barcode').value,
            category: document.getElementById('category').value,
            supplier_id: document.getElementById('supplierId').value || null,
            price: parseFloat(document.getElementById('price').value),
            cost_price: parseFloat(document.getElementById('costPrice').value) || 0,
            quantity: parseInt(document.getElementById('quantity').value),
            min_stock_level: parseInt(document.getElementById('minStockLevel').value),
            description: document.getElementById('description').value
        };

        try {
            const url = productId ? `/api/products/${productId}` : '/api/products';
            const method = productId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(productData)
            });

            const result = await response.json();
            
            if (response.ok && result.success) {
                showAlert(`Product ${productId ? 'updated' : 'added'} successfully`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                loadProducts();
            } else {
                showAlert(result.error || 'Error saving product', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Error saving product', 'danger');
        }
    }

    async function deleteProduct(id) {
        if (!confirm('Are you sure you want to delete this product?')) return;

        try {
            const response = await fetch(`/api/products/${id}`, { method: 'DELETE' });
            const result = await response.json();
            
            if (response.ok && result.success) {
                showAlert('Product deleted successfully', 'success');
                loadProducts();
            } else {
                showAlert(result.error || 'Error deleting product', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Error deleting product', 'danger');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadProducts();
        loadSuppliers();
    });
</script>
{% endblock %}