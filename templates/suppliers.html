{% extends "base.html" %}

{% block title %}Suppliers - Oil Shop Management{% endblock %}
{% block page_title %}Supplier Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-9">
            <input type="text" class="form-control" id="searchInput" placeholder="Search suppliers...">
        </div>
        <div class="col-md-3">
            <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#supplierModal" onclick="resetSupplierForm()">
                <i class="bi bi-plus-circle"></i> Add Supplier
            </button>
        </div>
    </div>

    <div class="card card-custom">
        <div class="card-body">
            <h5 class="card-title">
                <i class="bi bi-truck"></i> Supplier List
            </h5>
            <div class="table-responsive">
                <table class="table table-custom">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Contact Person</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Address</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="suppliersTable">
                        <tr>
                            <td colspan="7" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Supplier Modal -->
<div class="modal fade" id="supplierModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Supplier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="supplierForm">
                    <input type="hidden" id="supplierId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Supplier Name *</label>
                            <input type="text" class="form-control" id="supplierName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Contact Person</label>
                            <input type="text" class="form-control" id="contactPerson">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-control" id="phone">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Address</label>
                            <textarea class="form-control" id="address" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSupplier()">Save Supplier</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let suppliers = [];

    async function loadSuppliers() {
        try {
            const response = await fetch('/api/suppliers');
            suppliers = await response.json();
            displaySuppliers(suppliers);
        } catch (error) {
            console.error('Error loading suppliers:', error);
            showAlert('Error loading suppliers', 'danger');
        }
    }

    function displaySuppliers(supplierList) {
        const tbody = document.getElementById('suppliersTable');
        
        if (supplierList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">No suppliers found</td></tr>';
            return;
        }

        tbody.innerHTML = supplierList.map(supplier => `
            <tr>
                <td>${supplier.id}</td>
                <td><strong>${supplier.name}</strong></td>
                <td>${supplier.contact_person || 'N/A'}</td>
                <td>${supplier.phone || 'N/A'}</td>
                <td>${supplier.email || 'N/A'}</td>
                <td>${supplier.address || 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editSupplier(${supplier.id})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    {% if user.role == 'admin' %}
                    <button class="btn btn-sm btn-danger" onclick="deleteSupplier(${supplier.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                    {% endif %}
                </td>
            </tr>
        `).join('');
    }

    // Search
    document.getElementById('searchInput').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const filtered = suppliers.filter(s => 
            s.name.toLowerCase().includes(searchTerm) ||
            (s.contact_person && s.contact_person.toLowerCase().includes(searchTerm)) ||
            (s.phone && s.phone.includes(searchTerm))
        );
        displaySuppliers(filtered);
    });

    function resetSupplierForm() {
        document.getElementById('supplierForm').reset();
        document.getElementById('supplierId').value = '';
        document.getElementById('modalTitle').textContent = 'Add Supplier';
    }

    function editSupplier(id) {
        const supplier = suppliers.find(s => s.id === id);
        if (!supplier) return;

        document.getElementById('supplierId').value = supplier.id;
        document.getElementById('supplierName').value = supplier.name;
        document.getElementById('contactPerson').value = supplier.contact_person || '';
        document.getElementById('phone').value = supplier.phone || '';
        document.getElementById('email').value = supplier.email || '';
        document.getElementById('address').value = supplier.address || '';
        
        document.getElementById('modalTitle').textContent = 'Edit Supplier';
        const modal = new bootstrap.Modal(document.getElementById('supplierModal'));
        modal.show();
    }

    async function saveSupplier() {
        const form = document.getElementById('supplierForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const supplierId = document.getElementById('supplierId').value;
        const supplierData = {
            name: document.getElementById('supplierName').value,
            contact_person: document.getElementById('contactPerson').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value,
            address: document.getElementById('address').value
        };

        try {
            const url = supplierId ? `/api/suppliers/${supplierId}` : '/api/suppliers';
            const method = supplierId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(supplierData)
            });

            const result = await response.json();
            
            if (response.ok && result.success) {
                showAlert(`Supplier ${supplierId ? 'updated' : 'added'} successfully`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('supplierModal')).hide();
                loadSuppliers();
            } else {
                showAlert(result.error || 'Error saving supplier', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Error saving supplier', 'danger');
        }
    }

    async function deleteSupplier(id) {
        if (!confirm('Are you sure you want to delete this supplier? This may affect related products.')) return;

        try {
            const response = await fetch(`/api/suppliers/${id}`, { method: 'DELETE' });
            const result = await response.json();
            
            if (response.ok && result.success) {
                showAlert('Supplier deleted successfully', 'success');
                loadSuppliers();
            } else {
                showAlert(result.error || 'Error deleting supplier', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('Error deleting supplier', 'danger');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadSuppliers();
    });
</script>
{% endblock %}